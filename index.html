<!DOCTYPE html>
<html lang="bn" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Cat | Persistent Voice Fix</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#6366f1', dark: '#0f172a' } } }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; height: 100dvh; background: #f8fafc; }
        
        /* Voice Wave Animation */
        .wave-container {
            position: absolute;
            width: 300px;
            height: 300px;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .is-listening .wave-container { display: flex; }
        .wave {
            position: absolute;
            border: 2px solid #6366f1;
            opacity: 0;
            border-radius: 50%;
            animation: ripple 2s infinite;
        }
        .wave:nth-child(2) { animation-delay: 0.5s; }
        .wave:nth-child(3) { animation-delay: 1s; }

        @keyframes ripple {
            0% { width: 100px; height: 100px; opacity: 0.8; }
            100% { width: 400px; height: 400px; opacity: 0; }
        }

        /* Cat Movement */
        #cat-stage { transform-origin: bottom center; z-index: 10; transition: transform 0.3s; }
        #head-group { transform-origin: 100px 145px; }
        .is-talking #head-group { animation: talk-shake 0.4s infinite alternate; }
        @keyframes talk-shake { from { transform: rotate(-4deg) translateY(0); } to { transform: rotate(4deg) translateY(-2px); } }

        /* Draggable Box */
        #speech-bubble { position: absolute; z-index: 100; width: 85vw; max-width: 300px; }
        .eye-lid { transform-origin: center; transition: transform 0.1s; }
        .blink .eye-lid { transform: scaleY(0.1); }
    </style>
</head>
<body class="dark:bg-dark">

    <div id="app" class="flex h-full relative overflow-hidden">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 w-72 bg-white dark:bg-slate-900 shadow-2xl transform -translate-x-full z-[1000] transition-transform">
            <div class="p-6">
                <p class="font-bold text-primary mb-4">SETTINGS</p>
                <input type="password" id="api-key" placeholder="OpenRouter API Key" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-800 border-none text-sm mb-4">
                <button onclick="saveSettings()" class="w-full bg-primary text-white py-3 rounded-xl font-bold">Apply & Start</button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col relative">
            <header class="p-6 flex justify-between items-center z-50">
                <button onclick="toggleSidebar()" class="w-10 h-10 bg-white/80 dark:bg-gray-800 rounded-xl shadow-sm"><i class="fas fa-cog text-primary"></i></button>
                <div id="active-indicator" class="flex items-center gap-2 px-3 py-1 rounded-full bg-white/50 text-[10px] font-black uppercase tracking-tighter text-gray-400">
                    <div id="led" class="w-2 h-2 rounded-full bg-gray-300"></div>
                    <span id="status-text">Standby</span>
                </div>
            </header>

            <div class="flex-1 flex flex-col items-center justify-center relative">
                
                <div class="wave-container">
                    <div class="wave"></div>
                    <div class="wave"></div>
                    <div class="wave"></div>
                </div>

                <div id="speech-bubble" style="left: 20px; top: 100px;">
                    <div class="bg-white/90 dark:bg-gray-900/90 backdrop-blur-md p-5 rounded-[2.5rem] shadow-xl border border-white/20">
                        <div id="drag-handle" class="w-12 h-1 bg-gray-200 dark:bg-gray-700 mx-auto mb-3 rounded-full cursor-move"></div>
                        <p id="user-transcript" class="text-primary font-bold text-lg mb-1 min-h-[1.5rem]"></p>
                        <p id="ai-caption" class="text-gray-400 text-sm italic"></p>
                    </div>
                </div>

                <div id="cat-stage">
                    <svg viewBox="0 0 200 200" class="w-64 h-64 sm:w-80 sm:h-80 lg:w-[450px]">
                        <path d="M40 190 Q100 160 160 190 L170 200 L30 200 Z" fill="#4f46e5" />
                        <g id="head-group">
                            <path id="ear-l" d="M55 45 L35 10 L75 35 Z" fill="#4338ca" />
                            <path id="ear-r" d="M145 45 L165 10 L125 35 Z" fill="#4338ca" />
                            <circle cx="100" cy="100" r="80" fill="#6366f1" />
                            <circle cx="100" cy="110" r="62" fill="#e0e7ff" />
                            <g id="eyes">
                                <circle class="eye-lid" cx="78" cy="105" r="7" fill="#1e293b" />
                                <circle class="eye-lid" cx="122" cy="105" r="7" fill="#1e293b" />
                            </g>
                            <ellipse id="mouth-path" cx="100" cy="138" rx="12" ry="1" fill="#1e293b" />
                        </g>
                    </svg>
                </div>

                <div class="absolute bottom-10 flex flex-col items-center gap-4">
                    <button id="mic-btn" onclick="toggleVoiceMode()" class="w-20 h-20 rounded-full bg-white dark:bg-gray-800 shadow-2xl flex items-center justify-center text-2xl active:scale-95 transition-all">
                        <i id="mic-icon" class="fas fa-microphone text-gray-300"></i>
                    </button>
                    <p class="text-[9px] font-bold text-gray-400 uppercase">Continuous Mode</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const STATE = {
            active: false,
            speaking: false,
            recognition: null,
            watchdog: null,
            config: { key: localStorage.getItem('cat_key') || '', model: 'google/gemini-flash-1.5-8b' }
        };

        function setupRecognition() {
            const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRec) return alert("Browser supports standard recognition only.");

            STATE.recognition = new SpeechRec();
            STATE.recognition.lang = 'bn-BD';
            STATE.recognition.continuous = false; // Better for mobile stability
            STATE.recognition.interimResults = false;

            STATE.recognition.onstart = () => {
                updateUI('LISTENING');
                resetWatchdog(); // Start timing for silence
            };

            STATE.recognition.onresult = (event) => {
                clearTimeout(STATE.watchdog);
                const text = event.results[0][0].transcript;
                document.getElementById('user-transcript').innerText = text;
                sendToAI(text);
            };

            STATE.recognition.onend = () => {
                // AUTO-RECOVER IF MIC DIES
                if (STATE.active && !STATE.speaking) {
                    setTimeout(() => {
                        try { STATE.recognition.start(); } catch(e) {}
                    }, 200);
                }
            };

            STATE.recognition.onerror = (e) => {
                if (e.error === 'no-speech') {
                    console.log("No speech detected, recovering...");
                    // Silent recovery already handled by onend
                }
            };
        }

        // --- THE WATCHDOG (Prevents AI from going "Deaf") ---
        function resetWatchdog() {
            clearTimeout(STATE.watchdog);
            if (STATE.active && !STATE.speaking) {
                STATE.watchdog = setTimeout(() => {
                    console.log("Watchdog: Restarting mic due to silence...");
                    STATE.recognition.stop(); // This triggers onend which restarts the mic
                }, 10000); // 10 seconds of pure silence
            }
        }

        async function sendToAI(text) {
            if (!STATE.config.key) return alert("Please enter API key!");
            updateUI('THINKING');
            
            try {
                const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${STATE.config.key}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: STATE.config.model,
                        messages: [{ role: 'system', content: 'You are a cat. Short 1 sentence response in Bengali.' }, { role: 'user', content: text }]
                    })
                });
                const data = await res.json();
                const reply = data.choices[0].message.content;
                document.getElementById('ai-caption').innerText = reply;
                speak(reply);
            } catch (e) {
                updateUI('ERROR');
            }
        }

        function speak(text) {
            STATE.speaking = true;
            STATE.recognition.stop();
            updateUI('SPEAKING');

            const ut = new SpeechSynthesisUtterance(text);
            ut.lang = 'bn-BD';
            
            // Mouth Animation
            const mouth = document.getElementById('mouth-path');
            const mInt = setInterval(() => mouth.setAttribute('ry', Math.random() * 9 + 1), 80);

            ut.onend = () => {
                STATE.speaking = false;
                clearInterval(mInt);
                mouth.setAttribute('ry', '1');
                if (STATE.active) STATE.recognition.start(); // Go back to listening
            };
            window.speechSynthesis.speak(ut);
        }

        function updateUI(mode) {
            const app = document.getElementById('app');
            const icon = document.getElementById('mic-icon');
            const led = document.getElementById('led');
            const status = document.getElementById('status-text');

            app.classList.remove('is-listening', 'is-talking');
            led.className = "w-2 h-2 rounded-full ";
            
            if (mode === 'LISTENING') {
                app.classList.add('is-listening');
                icon.className = "fas fa-microphone text-primary";
                led.classList.add('bg-green-500', 'animate-pulse');
                status.innerText = "Listening...";
            } else if (mode === 'SPEAKING') {
                app.classList.add('is-talking');
                icon.className = "fas fa-comment text-indigo-500";
                led.classList.add('bg-blue-500');
                status.innerText = "Talking...";
            } else if (mode === 'THINKING') {
                icon.className = "fas fa-circle-notch fa-spin text-primary";
                status.innerText = "Thinking...";
            } else {
                icon.className = "fas fa-microphone text-gray-300";
                led.classList.add('bg-gray-300');
                status.innerText = "Standby";
            }
        }

        function toggleVoiceMode() {
            STATE.active = !STATE.active;
            if (STATE.active) {
                setupRecognition(); // Ensure engine is ready
                STATE.recognition.start();
            } else {
                STATE.recognition.stop();
                window.speechSynthesis.cancel();
                updateUI('STANDBY');
            }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('-translate-x-full'); }
        function saveSettings() {
            STATE.config.key = document.getElementById('api-key').value;
            localStorage.setItem('cat_key', STATE.config.key);
            toggleSidebar();
        }

        window.onload = () => {
            document.getElementById('api-key').value = STATE.config.key;
            setInterval(() => {
                const eyes = document.getElementById('eyes');
                eyes.classList.add('blink');
                setTimeout(() => eyes.classList.remove('blink'), 150);
            }, 4000);
            
            // Setup Draggable
            const bubble = document.getElementById('speech-bubble');
            let px = 0, py = 0, ix, iy;
            bubble.onpointerdown = (e) => {
                ix = e.clientX - px; iy = e.clientY - py;
                document.onpointermove = (ev) => {
                    px = ev.clientX - ix; py = ev.clientY - iy;
                    bubble.style.transform = `translate3d(${px}px, ${py}px, 0)`;
                };
                document.onpointerup = () => document.onpointermove = null;
            };
        };
    </script>
</body>
</html>
